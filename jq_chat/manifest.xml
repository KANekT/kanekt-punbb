<?xml version="1.0" encoding="utf-8"?>
<!--
/*
 * manifest file for jQuery Chat
 *
 * @copyright Copyright (C) 2009 KANekT @ http://blog.teamrip.ru
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * @package jQuery Chat
*/
-->

<extension engine="1.0">
	<id>jq_chat</id>
	<title>jQuery Chat</title>
	<version>0.3.0</version>
	<description>Adds a jQuery chat to the forum index.</description>
	<author>KANekT</author>
	<minversion>1.3</minversion>
	<maxtestedon>1.3.4</maxtestedon>

	<dependencies>
		<dependency>jquery</dependency>
	</dependencies>

	<install><![CDATA[

// check the PHP version
if(version_compare(PHP_VERSION, '5.2.1') === -1) {
	$notices[] = '<strong>ERROR !</strong> PHP 5.2.1 or superior required ('.PHP_VERSION.' found). This extension cannot be run on your server, please uninstall it.';
}
// check write access on some files
if(!is_writable($ext_info['path'].'/data/chat.dat') || !is_writable($ext_info['path'].'/data/.htaccess')) {
	$notices[] = '<strong>WARNING !</strong> Write access needed. Please give php the permission to write in <em>jq_chat/data/chat.dat</em> and <em>jq_chat/data/.htaccess</em> before running the chat.';
}
				$query = array(
				   'INSERT'  => 'conf_name, conf_value',
				   'INTO'    => 'config',
				   'VALUES'  => '\'o_log_view\', \'0\'' 
				);
				$forum_db->query_build($query);
				$query = array(
				   'INSERT'  => 'conf_name, conf_value',
				   'INTO'    => 'config',
				   'VALUES'  => '\'o_guest_write\', \'0\'' 
				);				
				$forum_db->query_build($query);
				$query = array(
				   'INSERT'  => 'conf_name, conf_value',
				   'INTO'    => 'config',
				   'VALUES'  => '\'o_guest_read\', \'0\'' 
				);				
				$forum_db->query_build($query);
				$query = array(
				   'INSERT'  => 'conf_name, conf_value',
				   'INTO'    => 'config',
				   'VALUES'  => '\'o_chat_on\', \'1\'' 
				);				
				$forum_db->query_build($query);

	]]></install>
	<uninstall>
		<![CDATA[
			$query = array(
				'DELETE' => 'config',
				'WHERE'		=> 'conf_name in (\'o_log_view\')',
			);
			$forum_db->query_build($query);
			$query = array(
				'DELETE' => 'config',
				'WHERE'		=> 'conf_name in (\'o_guest_write\')',
			);
			$forum_db->query_build($query);
			$query = array(
				'DELETE' => 'config',
				'WHERE'		=> 'conf_name in (\'o_guest_read\')',
			);
			$forum_db->query_build($query);
			$query = array(
				'DELETE' => 'config',
				'WHERE'		=> 'conf_name in (\'o_chat_on\')',
			);
			$forum_db->query_build($query);
		]]>
	</uninstall>
	<hooks>
		<hook id="hd_head" priority="10"><![CDATA[
		if ($forum_config['o_chat_on'] == '1')
		{

		// add javascript and style files on the Index
		if(FORUM_PAGE === 'index') {
			$forum_head['jq_chat_js'] = '<script type="text/javascript" src="'.$ext_info['url'].'/chat.js"></script>';

			$jq_chat_css = (file_exists($ext_info['path'].'/'.$forum_user['style'].'.css')) ? $forum_user['style'] : 'default';
			$forum_head['style_jq_chat'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/'.$jq_chat_css.'.css" />';
			}
		}
		]]></hook>
		
		<hook id="in_main_output_start"><![CDATA[
		if ($forum_config['o_chat_on'] == '1')
		{

		if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
			require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
		else
			require $ext_info['path'].'/lang/English.php';

		if ($forum_user['is_guest']) $user=$lang_jq_chat['Guest'];
		else $user=$forum_user['username'];

		if ($forum_config['o_guest_read'] == '0' && $forum_user['is_guest'])
		{
			echo $lang_jq_chat['Chat guest off'];
		}
		else
		{

?><div>
	<div class="main-head">
		<h2 class="hn"><span><?php echo $lang_jq_chat['Chat'] ?></span></h2>
	</div>
<!-- Вот в этих 2-х div-ах будут идти наши сообщения из чата -->
<div class="chat r4">
<div id="chat_area"><!-- Сюда мы будем добавлять новые сообщения --></div>
</div>
<?php

		if ($forum_config['o_guest_write'] == '0' && $forum_user['is_guest'])
		{
			echo $lang_jq_chat['Chat guest index'];
		}
		else
		{
?>
<div class="chatform">
<form id="pac_form" action=""><!-- Наша форма с именем, сообщением и кнопкой для отправки -->
<table style="width: 100%;">
        <tr>
                <!-- Поле ввода сообщения -->
                <td style="width: 80%;">Сообщение: <input type="hidden" id="pac_name" class="r4" value="<?php echo $user ?>" readonly="readonly"><input type="text" id="pac_text" class="r4" value=""></td>
 
                <!-- Кнопка "Отправить" -->
                <td style="width: 20%;"><input type="submit" value="Отправить"></td>
        </tr>
</table>
</form>
</div>
<?php
		}
?>
</div>
<?php
		}
}
		]]></hook>
		
				<hook id="aop_features_general_fieldset_end"><![CDATA[
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
				else
					require $ext_info['path'].'/lang/English.php';
?>
				<div class="content-head">
					<h2 class="hn"><span><?php echo $lang_jq_chat['Chat name'] ?></span></h2>
				</div>
		<fieldset class="frm-group group<?php echo ++$forum_page['group_count'] ?>">
		<legend class="group-legend"><strong><?php echo $lang_jq_chat['Chat name'] ?></strong></legend>
			<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
				<div class="sf-box checkbox">
					<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="form[chat_on]" value="1"<?php if ($forum_config['o_chat_on'] == '1') echo ' checked="checked"' ?> /></span>
					<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_jq_chat['Chat desc'] ?></span> <?php echo $lang_jq_chat['Chat on'] ?></label>
				</div>
			</div>
			<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
				<div class="sf-box checkbox">
					<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="form[log_view]" value="1"<?php if ($forum_config['o_log_view'] == '1') echo ' checked="checked"' ?> /></span>
					<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_jq_chat['Chat desc'] ?></span> <?php echo $lang_jq_chat['Chat label'] ?></label>
				</div>
			</div>
			<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
				<div class="sf-box checkbox">
				<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="form[guest_read]" value="1"<?php if ($forum_config['o_guest_read'] == '1') echo ' checked="checked"' ?> /></span>
					<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_jq_chat['Chat desc'] ?></span> <?php echo $lang_jq_chat['Chat guest read'] ?></label>
				</div>
			</div>
			<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
				<div class="sf-box checkbox">
				<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="form[guest_write]" value="1"<?php if ($forum_config['o_guest_write'] == '1') echo ' checked="checked"' ?> /></span>
					<label for="fld<?php echo $forum_page['fld_count'] ?>"><span><?php echo $lang_jq_chat['Chat desc'] ?></span> <?php echo $lang_jq_chat['Chat guest write'] ?></label>
				</div>
			</div>
		</fieldset>

<?php
		]]></hook>
				<hook id="aop_features_validation"><![CDATA[
			if (!isset($form['chat_on']) || $form['chat_on'] != '1') $form['chat_on'] = '0';
			if (!isset($form['log_view']) || $form['log_view'] != '1') $form['log_view'] = '0';
			if (!isset($form['guest_read']) || $form['guest_read'] != '1') $form['guest_read'] = '0';
			if (!isset($form['guest_write']) || $form['guest_write'] != '1') $form['guest_write'] = '0';
		]]></hook>

	</hooks>
</extension>