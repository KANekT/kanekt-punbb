<?xml version="1.0" encoding="utf-8"?>
<!--
/*
 * manifest file for markItUp
 *
 * @copyright Copyright (C) KANekT @ http://blog.kanekt.ru
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * Donate Web Money Z104136428007 R346491122688
 * @package markItUp
*/
-->
<extension engine="1.0">
	<id>markitup</id>
	<title>markItUp! BB code</title>
	<version>0.2.0</version>
	<description>jQuery BBcode editor (markItUp! 1.1.6.1) based code - Trustmaster  (c) Cotonti Team </description>
	<author>KANekT</author>
	<minversion>1.3.4</minversion>
	<maxtestedon>1.3.4</maxtestedon>

	<dependencies>
		<dependency>jquery</dependency>
	</dependencies>

	<hooks>
		<hook id="hd_head"><![CDATA[
if (((FORUM_PAGE == 'viewtopic' && $forum_config['o_quickpost']) || in_array(FORUM_PAGE, array('post', 'postedit'))) || $forum_user['pun_bbcode_enabled'])
{
	if (!defined('FORUM_PARSER_LOADED')) require FORUM_ROOT.'include/parser.php';
		

	$forum_head['js_jq_bbcode1'] = '<script type="text/javascript" src="'.$ext_info['url'].'/js/jquery.markitup.js"></script>';
		if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.js'))
			$forum_head['js_jq_bbcode2'] = '<script type="text/javascript" src="'.$ext_info['url'].'/lang/'.$forum_user['language'].'.js"></script>';
				else
			$forum_head['js_jq_bbcode2'] = '<script type="text/javascript" src="'.$ext_info['url'].'/lang/English.js"></script>';
	$forum_head['js_jq_bbcode3'] = '<script type="text/javascript" src="'.$ext_info['url'].'/js/set.js"></script>';
	
	$forum_head['style_jq_bbcode1'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/skins/markitup/style.css" />';
	$forum_head['style_jq_bbcode2'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/style.css" />';
	$forum_head['js_jq_bbcode0'] = '<script language="javascript">
$(document).ready(function()	{
    $("textarea").markItUp(mySettings);
});
</script>';
}
		]]></hook>

		<hook id="co_common"><![CDATA[
			$pun_extensions_used = array_merge(isset($pun_extensions_used) ? $pun_extensions_used : array(), array($ext_info['id']));
		]]></hook>
        <hook id="ps_preparse_tags_start"><![CDATA[
		
			// add our tag to the list
			$tags[] = 's';
			$tags_opened[] = 's';
			$tags_closed[] = 's';
			$tags_inline[] = 's';
			$tags_trim[] = 's';

			$tags[] = 'center';
			$tags_opened[] = 'center';
			$tags_closed[] = 'center';
			$tags_inline[] = 'center';
			$tags_trim[] = 'center';

			$tags[] = 'justify';
			$tags_opened[] = 'justify';
			$tags_closed[] = 'justify';
			$tags_inline[] = 'justify';
			$tags_trim[] = 'justify';

			$tags[] = 'left';
			$tags_opened[] = 'left';
			$tags_closed[] = 'left';
			$tags_inline[] = 'left';
			$tags_trim[] = 'left';

			$tags[] = 'right';
			$tags_opened[] = 'right';
			$tags_closed[] = 'right';
			$tags_inline[] = 'right';
			$tags_trim[] = 'right';
			
			// add our tag to the list
			$tags[] = 'hide';
			$tags_fix[] = 'hide';
			$tags_block[] = 'hide';
			
			]]></hook>
		<hook id="ps_do_bbcode_replace"><![CDATA[

		$pattern[] = '#\[s\](.*?)\[/s\]#ms';
		$replace[] = '<s>$1</s>';
		$pattern[] = '#\[center\](.*?)\[/center\]#ms';
		$replace[] = '<div style="text-align:center">$1</div>';
		$pattern[] = '#\[justify\](.*?)\[/justify\]#ms';
		$replace[] = '<div style="text-align:justify">$1</div>';
		$pattern[] = '#\[left\](.*?)\[/left\]#ms';
		$replace[] = '<div style="text-align:left">$1</div>';
		$pattern[] = '#\[right\](.*?)\[/right\]#ms';
		$replace[] = '<div style="text-align:right">$1</div>';

if (!function_exists('bbcode_size_pregcallback')) {
	function bbcode_size_pregcallback($matches) {
		$sizes = array('1'=>'xx-small', '2'=>'x-small', '3'=>'small', '4'=>'medium', '5'=>'large', '6'=>'x-large', '7'=>'xx-large', 
			'+1'=>'150%', '+2'=>'200%', '+3'=>'300%', '-1'=>'80%', '-2'=>'60%', '-3'=>'40%');
		if (isset($sizes[$matches[1]]))
			return '<span style="font-size: '.$sizes[$matches[1]].';">'.$matches[2].'</span>';
		else
			return $matches[0];
	}
}
$text = preg_replace_callback('~\\[size=([1-7]|[+-][1-3])\\]([^<>]*)\\[/size\\]~isU', 'bbcode_size_pregcallback', $text);
		
        ]]></hook>
	<hook id="ps_parse_message_pre_split"><![CDATA[
		global $forum_url, $forum_page;
		
		if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
						require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
				else
						require $ext_info['path'].'/lang/English.php';
		
			if (strpos($text, 'hide') !== false && strpos($text, '/hide') !== false)
			{
				if ($forum_user['is_guest'])
				{
					$text = preg_replace('#\[hide\](.*?)\[\/hide\]#si', '[code]'.sprintf($lang_jqbb['Hidden text guest'], '<a href="'.forum_link($forum_url['login']).'">'.$lang_jqbb['login'].'</a>').'[/code]', $text);
					$text = preg_replace('#\[hide=([0-9]*)](.*?)\[/hide\]#si', '[code]'.sprintf($lang_jqbb['Hidden text guest'], '<a href="'.forum_link($forum_url['login']).'">'.$lang_jqbb['login'].'</a>').'[/code]', $text);
				}
				else if ($forum_page['is_admmod'])
				{
					$text = preg_replace('#\[hide=([0-9]*)](.*?)\[/hide\]#s', '<div class="quotebox"><cite>'.$lang_jqbb['Hidden text'].'[$1]:</cite><blockquote><p><i>$2</i></p></blockquote></div>', $text);
					$text = preg_replace('#\[hide](.*?)\[/hide\]#s', '<div class="quotebox"><cite>'.$lang_jqbb['Hidden text'].':</cite><blockquote><p><i>$1</i></p></blockquote></div><blockquote>', $text);
				}
				else 
				{
					$text = preg_replace('#\[hide](.*?)\[/hide\]#s', '<div class="quotebox"><cite>'.$lang_jqbb['Hidden text'].':</cite><blockquote><p><i>$1</i></p></blockquote></div><blockquote>', $text);
					
					$occurances = preg_match_all("#\[hide\=.+?\](.+?)\[/hide\]#is", $text, $temp); 
					for($i=0;$i<$occurances;$i++) 
					{ 
						preg_match("#\[hide\=(.+?)\].+?\[/hide\]#s", $temp[0][$i],$hide_count);
						if($forum_user['num_posts'] >= $hide_count[1])
						{
							$text_hide = preg_replace('#\[hide=([0-9]*)](.*?)\[/hide\]#s', '<div class="quotebox"><cite>'.$lang_jqbb['Hidden text'].'[$1]:</cite><blockquote><p><i>$2</i></p></blockquote></div>', $temp[0][$i]);
						}
						else
						{
							$text_hide = preg_replace("#\[hide=([0-9]*)](.*?)\[/hide\]#s", '<b>['.$lang_jqbb['Hidden count begin'].' '.$hide_count[1].' '.$lang_jqbb['Hidden count end'].']</b>', $temp[0][$i]);
							
						}
						if (isset($text_hide))
						{
							$text = str_replace($temp[0][$i], $text_hide, $text);
						}
					}
				}
				
				preg_match("#\[hide=gr.+?\].+?\[/hide\]#i", $text, $hide_group);
				if (strpos($text, 'hide=gr') !== false && strpos($text, '/hide') !== false)
				{
					$occurances = preg_match_all("#\[hide=gr.+?\](.+?)\[/hide\]#is", $text, $temp); 
					for($i=0;$i<$occurances;$i++) 
					{ 
						preg_match("#\[hide=gr(.+?)\].+?\[/hide\]#i", $temp[0][$i],$hide_group);
						if($forum_user['g_id'] == $hide_group[1] || $forum_page['is_admmod'])
						{
							$text_hide = preg_replace('#\[hide=gr([0-9]*)](.*?)\[/hide\]#s', '<div class="quotebox"><cite>'.$lang_jqbb['Hidden text group'].'[$1]:</cite><blockquote><p><i>$2</i></p></blockquote></div>', $temp[0][$i]);
						}
						else
						{
							$text_hide = preg_replace("#\[hide=gr([0-9]*)](.*?)\[/hide\]#s", '<b>['.$lang_jqbb['Hidden text group'].' '.$hide_group[1].']</b>', $temp[0][$i]);
						}
						if (isset($text_hide))
						{
							$text = str_replace($temp[0][$i], $text_hide, $text);
						}
					}
				}
			}

	]]></hook>
	<hook id="po_modify_quote_info"><![CDATA[
		$text = $q_message;
		if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
						require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
				else
						require $ext_info['path'].'/lang/English.php';
						
			if (strpos($text, 'hide') !== false && strpos($text, '/hide') !== false)
			{
				if ($forum_user['is_guest'])
				{
					$text = preg_replace('#\[hide\](.*?)\[\/hide\]#si', $lang_jqbb['Hidden text'], $text);
					$text = preg_replace('#\[hide=([0-9]*)](.*?)\[/hide\]#si', $lang_jqbb['Hidden text'], $text);
				}
				else if ($forum_page['is_admmod'])
				{
				}
				else 
				{
					$occurances = preg_match_all("#\[hide\=.+?\](.+?)\[/hide\]#is", $text, $temp); 
					for($i=0;$i<$occurances;$i++) 
					{ 
						preg_match("#\[hide\=(.+?)\].+?\[/hide\]#s", $temp[0][$i],$hide_count);

						if($forum_user['num_posts'] >= $hide_count[1])
						{
						}
						else
						{
							$text_hide = preg_replace("#\[hide=([0-9]*)](.*?)\[/hide\]#s", $lang_jqbb['Hidden text'], $temp[0][$i]);
							$text = str_replace($temp[0][$i], $text_hide, $text);
						}
					}
				}
				
				preg_match("#\[hide\=gr(.+?)\].+?\[/hide\]#i", $text, $hide_group);
				if (isset($hide_group[1]))
				{
					$occurances = preg_match_all("#\[hide\=gr.+?\](.+?)\[/hide\]#is", $text, $temp); 
					for($i=0;$i<$occurances;$i++) 
					{ 
						preg_match("#\[hide\=gr(.+?)\].+?\[/hide\]#i", $temp[0][$i],$hide_group);
						if($forum_user['g_id'] == $hide_group[1] || $forum_page['is_admmod'])
						{
							$text_hide = preg_replace('#\[hide\=gr([0-9]*)](.*?)\[/hide\]#s', '<div class="quotebox"><cite>'.$lang_jqbb['Hidden text group'].'[$1]:</cite><blockquote><p><i>$2</i></p></blockquote></div>', $temp[0][$i]);
						}
						else
						{
							$text_hide = preg_replace("#\[hide\=gr([0-9]*)](.*?)\[/hide\]#s", '<b>['.$lang_jqbb['Hidden text group'].' '.$hide_group[1].']</b>', $temp[0][$i]);
						}
						if (isset($text_hide))
						{
							$text = str_replace($temp[0][$i], $text_hide, $text);
						}
					}
				}
			}
			$q_message = $text;	
		]]></hook>
		<hook id="he_new_bbcode_text_style"><![CDATA[
		if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
						require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
				else
						require $ext_info['path'].'/lang/English.php';
			?><div class="entry-content">
				<code>[hide]<?php echo $lang_hide['Hidden text'] ?>[/hide]</code> <span><?php echo $lang_help['produces'] ?></span>
				<div class="quotebox"><cite><?php echo $lang_hide['Hidden text'] ?></cite><blockquote><p><i><?php echo $lang_hide['Hidden text'] ?></i></blockquote></p></div>
				<code>[hide=1]<?php echo $lang_hide['Hidden text'] ?>[/hide]</code> <span><?php echo $lang_help['produces'] ?></span>
				<div class="quotebox"><cite><?php echo $lang_hide['Hidden text'] ?>[1]</cite><blockquote><p><i><?php echo $lang_hide['Hidden text'] ?></i></blockquote></p></div>
				<code>[hide=gr1]<?php echo $lang_hide['Hidden text'] ?>[/hide]</code> <span><?php echo $lang_help['produces'] ?></span>
				<div class="quotebox"><cite><?php echo $lang_hide['Hidden text group'] ?>[1]</cite><blockquote><p><i><?php echo $lang_hide['Hidden text group'] ?>1</i></blockquote></p></div>
			</div><?
			]]></hook>
		
		</hooks>
</extension>
