<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
/**
 * Adds CAPTCHA to the register, login and guest post form
 *
 * @copyright Copyright (C) 2008 PunBB, partially based on code by Jamie Furness
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * @package KCAPTCHA
 */
-->

	<extension engine="1.0">
	<id>update_user_post_count</id>
	<title>Update Post</title>
	<version>0.01.4</version>
	<description>Update User Post Count</description>
	<author>KANekT</author>
	<minversion>1.3</minversion>
	<maxtestedon>1.3.3</maxtestedon>

	<install><![CDATA[

	]]></install>

	<uninstall><![CDATA[

	]]></uninstall>

	<hooks>
		<hook id="ca_fn_generate_admin_menu_new_sublink"><![CDATA[
			if (FORUM_PAGE_SECTION == 'management')
			{
				global $lang_uupc;
				$forum_page['admin_submenu']['user-post-count'] = '<li class="'.((FORUM_PAGE == 'admin-user-post-count') ? 'active' : 'normal').((empty($forum_page['admin_submenu'])) ? ' first-item' : '').'"><a href="'.forum_link($forum_url['admin_user_post_count']).'">'.$lang_uupc['Update User Post Count'].'</a></li>';
			}
		]]></hook>
		<hook id="co_modify_url_scheme"><![CDATA[
			$forum_url['admin_user_post_count'] = 'admin/settings.php?section=uupc';  
		]]></hook>
		<hook id="co_common"><![CDATA[
			require_once $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
		]]></hook>
		<hook id="aop_new_section"><![CDATA[
			if ($section == 'uupc')
			{
				global $lang_uupc;
				$query_UUPC = array(
					'SELECT'	=> 'id',
					'FROM'		=> 'users'
				);
				$result_UUPC = $forum_db->query_build($query_UUPC) or error(__FILE__, __LINE__);
				while($row = $forum_db->fetch_assoc($result_UUPC))
				{
					$query_While = array(
						'UPDATE'	=> 'users',
						'SET'		=> 'num_posts=(SELECT count(id) AS kol FROM '.$forum_db->prefix.'posts a where a.poster_id='.$row['id'].')', 
						'WHERE'		=> 'id='.$row['id']
					);
					$forum_db->query_build($query_While);
				}
				
				redirect(forum_link($forum_url['admin_reports']), $lang_uupc['Post User Count Updated']);

			}
		]]></hook>
		<hook id="dl_post_deleted_pre_redirect"><![CDATA[
				$query_Ref = array(
					'UPDATE'	=> 'users b, (SELECT poster_id, count(id) AS kol FROM '.$forum_db->prefix.'posts GROUP BY poster_id) a',
					'SET'		=> 'b.num_posts=a.kol', 
					'WHERE'		=> 'b.id = a.poster_id'
				);
				$result = $forum_db->query_build($query_Ref);
		]]></hook>

	</hooks>

</extension>