<?xml version="1.0" encoding="utf-8"?>
<!--
/*
 * manifest file for topic description
 *
 * @copyright Copyright (C) KANekT @ http://blog.kanekt.ru
 * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
 * Donate Web Money Z104136428007 R346491122688
 * @package topic description
*/
-->
<extension engine="1.0">
	<id>topic_desc</id>
	<title>topic description</title>
	<version>0.2.0</version>
	<description>Topic Description</description>
	<author>KANekT</author>
	<minversion>1.3</minversion>
	<maxtestedon>1.3.4</maxtestedon>
	<install>
		<![CDATA[
				$forum_db->add_field('topics', 'topic_desc', 'varchar(255)', true);
		]]>
	</install>
	<uninstall>
		<![CDATA[
			$forum_db->drop_field('topics', 'topic_desc');
		]]>
	</uninstall>
	<hooks>
		<hook id="po_pre_post_contents" priority = "2">
			<![CDATA[
			if ($fid)
			{
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
				else
					require $ext_info['path'].'/lang/English.php';
				?>
				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
					<div class="sf-box text required longtext">
						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_topic['Topic Description']; ?></span></label><br />
							<span class="fld-input"><input id="fld<?php echo $forum_page['fld_count'] ?>" type="text" name="topic_desc" value="<?php echo empty($_POST['topic_desc']) ? '' : forum_htmlencode($_POST['topic_desc']) ?>" size="80" maxlength="100"/></span>
					</div>
				</div>
			<?php
			}
			]]>
		</hook>
		<hook id="po_end_validation, mr_confirm_split_posts_form_submitted"><![CDATA[
			if (!empty($_POST['topic_desc']))
				$new_desc = utf8_trim($_POST['topic_desc']);
		]]></hook>
		<hook id="po_pre_add_topic"><![CDATA[
			$post_info['topic_desc'] = $new_desc;
		]]></hook>		
		<hook id="fn_add_topic_qr_add_topic"><![CDATA[
			if ($post_info['topic_desc'] != null)
			{
				$query['INSERT'] .= ', topic_desc';
				$query['VALUES'] .= ', \''.$forum_db->escape($post_info['topic_desc']).'\'';
			}
		]]></hook>		
		<hook id="ed_qr_get_post_info"><![CDATA[
				$query['SELECT'] .= ', topic_desc';
		]]></hook>
		<hook id="ed_pre_message_box" priority = "2"><![CDATA[
				if (file_exists($ext_info['path'].'/lang/'.$forum_user['language'].'.php'))
					require $ext_info['path'].'/lang/'.$forum_user['language'].'.php';
				else
					require $ext_info['path'].'/lang/English.php';
			
			if(isset($cur_post['topic_desc']) || isset($_POST['topic_desc']))
			{
			if ($can_edit_subject): 
			?>
				<div class="sf-set set<?php echo ++$forum_page['item_count'] ?>">
					<div class="sf-box text required longtext">
						<label for="fld<?php echo ++$forum_page['fld_count'] ?>"><span><?php echo $lang_topic['Topic Description']; ?></span></label><br />
							<span class="fld-input"><input id="fld<?php echo $forum_page['fld_count'] ?>" type="text" name="topic_desc" value="<?php echo forum_htmlencode(isset($_POST['topic_desc']) ? $topic_desc : $cur_post['topic_desc']) ?>" size="80" maxlength="100"/></span>
					</div>
				</div>
			<?php
			endif; 
			}
		]]></hook>
		<hook id="ed_qr_update_subject"><![CDATA[
			$topic_desc = forum_trim($_POST['topic_desc']);

			$query['SET'] .= ', topic_desc=\''.$forum_db->escape($topic_desc).'\'';
		]]></hook>
		<hook id="vf_qr_get_topics"><![CDATA[
				$query['SELECT'] .= ', t.topic_desc';
		]]></hook>
		<hook id="vf_row_pre_item_subject_merge"><![CDATA[
				$forum_page['item_body']['subject']['topic_desc'] = '<p><small>'.forum_htmlencode($cur_topic['topic_desc']).'</small></p>';
		]]></hook>
	</hooks>
</extension>
